# Render.com Blueprint for JobAutoFlow
# Deploy this to Render for FREE hosting
# https://render.com/docs/blueprint-spec

services:
  # Backend API Service
  - type: web
    name: jobautoflow-api
    runtime: node
    plan: free
    region: oregon  # Choose: oregon, ohio, frankfurt, singapore
    
    buildCommand: |
      cd backend && 
      npm install && 
      npx prisma generate && 
      npm run build
    
    startCommand: |
      cd backend && 
      npx prisma migrate deploy && 
      npm start
    
    healthCheckPath: /health
    
    envVars:
      - key: NODE_ENV
        value: production
      
      - key: PORT
        value: 10000
      
      # Database (Supabase)
      - key: DATABASE_URL
        sync: false  # Set in Render dashboard
      
      # Redis (Upstash)
      - key: REDIS_HOST
        sync: false
      
      - key: REDIS_PORT
        value: 6379
      
      - key: REDIS_PASSWORD
        sync: false
      
      # JWT Secrets
      - key: JWT_SECRET
        sync: false
        generateValue: true  # Auto-generate if not set
      
      - key: JWT_REFRESH_SECRET
        sync: false
        generateValue: true
      
      - key: JWT_ACCESS_EXPIRATION
        value: 15m
      
      - key: JWT_REFRESH_EXPIRATION
        value: 7d
      
      # Stripe (Test Mode)
      - key: STRIPE_SECRET_KEY
        sync: false
      
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      
      # Email
      - key: SENDGRID_API_KEY
        sync: false
      
      - key: EMAIL_FROM
        value: noreply@jobautoflow.com
      
      - key: EMAIL_FROM_NAME
        value: JobAutoFlow
      
      # OpenAI
      - key: OPENAI_API_KEY
        sync: false
      
      - key: OPENAI_MODEL
        value: gpt-3.5-turbo
      
      # Frontend URL (update after Vercel deployment)
      - key: FRONTEND_URL
        value: https://jobautoflow.vercel.app
    
    # Auto-deploy on git push
    autoDeploy: true

  # Background Worker (Optional - for processing jobs)
  - type: worker
    name: jobautoflow-worker
    runtime: node
    plan: free
    region: oregon
    
    buildCommand: |
      cd backend && 
      npm install && 
      npx prisma generate
    
    startCommand: |
      cd backend && 
      node dist/jobs/worker.js
    
    envVars:
      - key: NODE_ENV
        value: production
      
      - key: DATABASE_URL
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: DATABASE_URL
      
      - key: REDIS_HOST
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: REDIS_HOST
      
      - key: REDIS_PASSWORD
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: REDIS_PASSWORD
      
      - key: OPENAI_API_KEY
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: OPENAI_API_KEY

  # Cron Job (for scheduled tasks)
  - type: cron
    name: jobautoflow-cron
    runtime: node
    plan: free
    region: oregon
    
    # Run every hour
    schedule: "0 * * * *"
    
    buildCommand: |
      cd backend && 
      npm install && 
      npx prisma generate
    
    startCommand: |
      cd backend && 
      node dist/jobs/cron.js
    
    envVars:
      - key: NODE_ENV
        value: production
      
      - key: DATABASE_URL
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: DATABASE_URL
      
      - key: REDIS_HOST
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: REDIS_HOST
      
      - key: REDIS_PASSWORD
        fromService:
          type: web
          name: jobautoflow-api
          envVarKey: REDIS_PASSWORD

# Note: Frontend is deployed separately to Vercel
# See docs/FREE-DEPLOYMENT.md for instructions
